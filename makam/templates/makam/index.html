{% extends "makam/base.html" %}
{% load staticfiles %}
{% load makam.inline %}

{% block extra_css %}
    {% if debug %}
    {% load less %}
    {% load static %}
    <link rel="stylesheet" type="text/css" href="{% get_static_prefix %}{% less 'carnatic/css/pages.less' %}" />
    {% else %}
    <link rel="stylesheet" type="text/css" href="{% static 'carnatic/css/pages.css' %}" />
    {% endif %}
{% endblock %}
{% block title %}Makam index | {% endblock %}
{% block script %}
<style>

  .custom-combobox {
    position: relative;
    display: inline-block;
  }
  .custom-combobox-toggle {
    position: absolute;
    top: 0;
    bottom: 0;
    margin-left: -1px;
    padding: 0;
  }
  .custom-combobox-input {
    margin: 0;
    padding: 5px 10px;
  }
#one-column-emphasis th
{
  font-size: 14px;
  font-weight: normal;
  padding: 12px 15px;
  color: #039;
}
#one-column-emphasis td
{
  padding: 10px 15px;
  color: #669;
  border-top: 1px solid #e8edff;
  width: 300px;
vertical-align: top;
}
.oce-first
{
  background: #d0dafd;
  border-right: 10px solid transparent;
  border-left: 10px solid transparent;
}
#one-column-emphasis tr:hover td
{
  color: #339;
  background: #eff2ff;
}
#one-column-emphasis
{
  font-family: "Lucida Sans Unicode", "Lucida Grande", Sans-Serif;
  font-size: 12px;
  margin-left: 45px;
  width: 480px;
  text-align: left;
  border-collapse: collapse;
}
#one-column-emphasis th
{
  font-size: 14px;
  font-weight: bold;
  padding: 12px 15px;
  color: #039;
}
#one-column-emphasis td a
{
  color: #669;
  text-decoration: none;
  display:block;
  height:100%;
  width:100%;
} 
.filters{
  padding-left: 42px;
 /* color: #339;*/
  margin-top: 5px;
}
.pagination{
margin: 10px 0 25px 42px;
font-size: 14px;
}
.step-links{
border-top: 1px black solid;
}
#right-display{
  position: fixed;
  top: 100px;
  right: 100px;
  border: 1px #ccc solid;
  padding: 13px;
  border-radius: 9px;
  background-color: #FFFFD1;
}
#right-display ul{
list-style-type: none;
}
#right-display a{
  text-decoration: none;
  color: #339;
}
td.recodings{
width: 400px;
}
a:hover{
  text-decoration: underline !important;
}
h2{
  margin: 30px 0 0 20px;
  color: #46433a;
  font-size: 30px;
  font-family: 'Roboto', sans-serif;
  font-weight: 300;
}
#results{
margin-left: 30px;
}
#initial, #loading, #no-results{
  font-family: 'Sintony', sans-serif;
  font-size: 14px;
  margin-left: 30px;
  margin-top: 40px;
  color: #46433a;
  min-height: 20px;
  padding: 19px;
  margin-bottom: 20px;
  background-color: #f9f6f5;
  border: 1px solid #ebe2df;
  border-radius: 2px;
  -webkit-box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.05);
  box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.05);
  max-width: 1200px;
}
#initial a{
  color: #46433a;
}
#next-page{
  display: inline-block;
  padding: 5px 14px;
  background-color: #ffffff;
  border: 1px solid #dddddd;
  border-radius: 2px;
margin: 20px;
}
</style>
<script src="{% static 'makam/js/works.js' %}"></script>
<script>
$(function() {      
    $( "#combo-artist" ).combobox();
      $( "#toggle" ).click(function() {
          $( "#combo-artist" ).toggle();
     });
  });
function loadTable(data){
  $('#no-results').hide();
  if (data['results'].length==0){
    $('#next').hide();
    $('#results').hide();
    var usul = $('#usul-filter option:selected').val(); 
    var makam = $('#makam-filter option:selected').val(); 
    var form = $('#form-filter').find('option:selected').val();
    var artist = $('#combo-artist option:selected').val();
    
    if (usul || makam || form || artist){
        $('#no-results').find('h3').html("There are no results for this search. Try removing some filters.");
    }else{
        $('#no-results').find('h3').html("There are no results for this search.");
    }
    $('#no-results').show();
    $('#initial').show();
  }else{
    if(data['next']){
      $('#next').show();
      $('#next a').attr('href', data['next']);
    }else{
      $('#next').hide();
    }
    $('#one-column-emphasis').html('<tr><th scope="col">Work name</th><th scope="col">Composer</th><th scope="col">Recordings</th></tr>');
    for(var i=0; i<data['results'].length; i++){
      var artists="";
      var art=data['results'][i]['composers'];
      for(var j=0;j<art.length;j++){
        artists += " "+art[j]['name'];
      }
      $('#one-column-emphasis').append('<tr class="work"><td height="30">'+ data['results'][i]['title'] +'</td><td >'+ artists +'</td><td><div class="recordings" data-id="'+ data['results'][i]['mbid']+'"><a href="#">Show</a></div></td></tr>');
    }
    $('#initial').hide();
  }
}

function getWorks(txt){
  $('#loading').show();
  var usul = $('#usul-filter option:selected').val(); 
  var makam = $('#makam-filter option:selected').val(); 
  var form = $('#form-filter').find('option:selected').val();
  var artist = $('#combo-artist option:selected').val();
   
  $.ajax({
      method: "GET",
      url: "{% url "api-makam-work-list" %}",
      dataType: "json",
      data: {"q":txt.trim(),"usul":usul, "artist":artist, "form":form, "makam": makam},
      }).done(function(data) {
         $('#results').show();
         loadTable(data); 
         $('#loading').hide();
      }).fail(function(jqXHR, textStatus ){
         $('#loading').hide();
      });
}

$( document ).ready(function() {
 $("#work-query").keyup(function(event) {
  var stt=$(this).val();
  getWorks(stt); 
  });
  $('form.filters').submit(function() {
    return false;
    });
  $("#submit-filters").submit(function(){
    getWorks($('#work-query').val());
    return false;
  });
  
  // WHEN CLICK SHOW THE RECORDINGS FOR A WORK
  $('#one-column-emphasis').on('click','div.recordings', function() {
   var work=$(this);
   $.ajax({
    method: "GET",
    url: "/api/makam/work/" +$(this).attr('data-id'),
    dataType: "json",
    }).done(function(data) {
     $('.recordings').each(function(){$(this).html('<a href="#"">Show</a>')});; 
     work.html('<ul></ul>');
     for(var i=0; i<data['recordings'].length; i++){
       var art=data['recordings'][i]['artists'];
       var artists="";
       for(var j=0;j<art.length;j++){
         artists += " "+art[j]['name'];
       }
       work.parent().find('ul').append('<li><a href="/makam/recording/'+data['recordings'][i]['mbid'] +'">'+data['recordings'][i]['title'] + ' ('+ artists +')</li>'); 
     }
    }); 
      
  });
$(function() {      
    $( "#combo-artist" ).combobox();
      $( "#toggle" ).click(function() {
          $( "#combo-artist" ).toggle();
     });
  });
$('#disp-filters-btn').click(function(){
    $("#disp-filters").toggle();
});
$('#next-page').click(function(){
 var href = $(this).attr('href');
 $.ajax({
      method: "GET",
      url: href,
      dataType: "json",
      }).done(function(data) {
         loadTable(data); 
    });
return false;
});

});
</script>
{% endblock%}
{%block extra-search%}
        <label for="query">Work name</label>
        <input type="text" name="query" id="work-query"/>
        <div><a href="#" id="disp-filters-btn">Show filters</a></div>
 
{% endblock%}

{% block wrap %}
<div id="detail"   style="min-height: 850px;">

    <form method="get" class="filters" id="submit-filters">
       <div id="disp-filters" style="display:none">
           <label for="form">Musical Form</label>
           <select name="form" id="form-filter">
               <option value="">Select</option>
           {% for i in forms%}
               <option value="{{i.pk}}" {%if i.pk|slugify == form %}selected{% endif%}>{{i.name}}</option>
           {% endfor %}
            </select> 
          <label for="usual">Usul</label>
          <select name="usul" id="usul-filter">
             <option value="">Select</option>
             {% for i in usuls%}
                 <option value="{{i.pk}}" {%if i.pk|slugify == usul %}selected{% endif%}>{{i.name}}</option>
             {% endfor %}
          </select>
         <label for="makam">Makam</label>
          <select name="makam" id="makam-filter">
             <option value="">Select</option>
             {% for i in makams%}
                 <option value="{{i.pk}}" {%if i.pk|slugify == usul %}selected{% endif%}>{{i.name}}</option>
             {% endfor %}
          </select>

         <label for="artist">Composer</label>
          <select name="artist" id="combo-artist">
             <option value="">Select one...</option>
             <option value="">Select</option>
             {% for i in artists%}
                 <option value="{{i.pk}}" {%if i.pk|slugify == artist %}selected{% endif%}>{{i.name}}</option>
             {% endfor %}
          </select>
          <input type="submit" value="Search" style="margin-left: 30px;">
        </div>

    </form>
    <div id="results"  style="display:none">
        <h2>Results</h2>    
        <table  style="margin-left:30px;  min-width: 1200px;" id="one-column-emphasis">
        </table>
        <div id="next">
            <a href="#" id="next-page">next</a>
        </div>
    </div>
    <div id="no-results"  style="display:none">
        <h3> There are no results for this search. 
        </h3>
    </div>

    <div id="loading" style="display:none">
        <p> Please wait, loading
        <img src="{% static 'makam/img/loader.gif' %}" />
        </p>
    </div>
    <div id="initial">
        <p> Welcome to the demo of Dunya Turkish-makam.</br> 
        <p class="p1"><span class="s1">Above, you can search the works by name, or filter searches by makam, musical form, usul or composer. </span></p>
        <p class="p1"><span class="s1">Below we have compiled some examples:</span></p>
        </p>
        
        <h2>Some Examples</h2>
        <ul>
            <li><a href="/makam/recording/dfc16e22-0aae-4bd0-a32c-5c000130e96a" ><b>Sevdi Gönlüm Ey Melek Sima Seni</b></a></li>
            <p class="p1"><span class="s1">This is a vocal recording of  "Sevdi Gönlüm" by <a href="http://musicbrainz.org/artist/87a4cda0-e64d-4d03-89c0-bdc8172207e2" target="_blank">Nikoğos Ağa</a>, the Armenian composer from 19th century Istanbul. The şarkı is sung by <a href="http://musicbrainz.org/artist/8919be74-e039-451a-b5db-aae414b06d65" target="_blank">Hafız Kemal Bey</a>, the head-<a href="https://en.wikipedia.org/wiki/Muezzin" target="_blank">müezzin</a> of <a href="https://en.wikipedia.org/wiki/S%C3%BCleymaniye_Mosque" target="_blank">Süleymaniye Mosque</a>. The performance was recorded in the start of the 20th century and shows the outstanding virtuosity of Kemal Bey. The recording starts with a brief improvisation from <a href="http://musicbrainz.org/artist/1fee0e91-31ac-4f09-b531-4bd550bd133c" target="_blank">Yorgo Bacanos</a>, one of the greatest performers of oud in 20th century. The Greek musician's technical virtuosity especially stands out in his fast and precise movements between the vocal sections. </span></p>
            <p class="p1"><span class="s1">The musical quality can be attributed to the tight interaction between Hafız Kemal Bey and Yorgo Bacanos, who have made occasional collaborations with each other. The performance realized by these two musicians also marks an important point in the multi-cultural world of Istanbul in early 20th century.</span></p>

            <li><a href="/makam/recording/727cff89-392f-4d15-926d-63b2697d7f3f" ><b>Gel Güzelim Çamlıca'ya </b></a></li>
            <p>
            This is a performance of <a href="http://musicbrainz.org/artist/8dd06d8b-b1f6-409e-b46d-4539a59f715e" target="_blank">Faiz Kapancı</a>'s famous composition sung by <a href="http://05ca8423-760a-4687-a57e-10cb590dfc86" target="_blank">Münir Nurettin Selçuk</a>, one of the best male vocals performing makam music. Münir Nurettin Selçuk is praised for his incredible control over the dynamics and articulation of his voice. Between 1:43 and 2:54 seconds in this recording, he also shows that he among the best gazel performers, a improvisational form/vocal section.
            </p>
            <li><a href="/makam/recording/4948c836-5485-4a69-8bdc-11fe4559e78f" ><b>Muhayyer Sazsemaisi</b></a></li>
            <p>
            This is a recording of <a href="http://musicbrainz.org/artist/4cc5200e-a3f7-4d5d-8b15-9b10a8f9a9a2" target="_blank">Tanburi Cemil Bey</a>'s sazsemaisi in Muhayyer makam performed solo by the oud performer, <a href="http://musicbrainz.org/artist/0a7cf3b7-97a1-4187-ac32-698a3ceb27a2" target="_blank">Necati Çelik</a>. The performer approaches the music with a fast paced and embellished manner. His performance incorporate many note repetitions and additions; He also uses inserts many bass lines, small motifs and unnotated scales.

           This piece is particularly hard (if conceptually possible) to side-read the score in the note-level. Nevertheless, our alignment algorithm is able to track the score except the 4th Hane between 2:46 and 3:15, where the section is performed in much faster than the notated tempo. Similarly, it cannot adapt to the abrupt tempo change in the end of the last Teslim performed.
            </p>
            <li><a href="/makam/recording/e72db0ad-2ed9-467b-88ae-1f91edcd2c59" ><b>Uşşâk Saz Semâîsi</b></a></li>
            <p>
            Here, we listen to one of the best contemporary collaborations, between <a title="Aydemir, Murat" href="http://musicbrainz.org/artist/9b6e98f8-b695-45da-8c9c-68d4bab460fd"><bdi>Murat Aydemir</bdi></a> &amp; <bdi><a title="Türkan, Derya" href="http://musicbrainz.org/artist/b80cd1ab-a00c-4f98-89c1-a798deb2d5c2">Derya Türkan</a>. Arguably the best living performers of <a href="http://musicbrainz.org/instrument/16f816ec-9ecf-4236-8006-19a4b27797f1" target="_blank">tanbur</a> and <a href="http://musicbrainz.org/instrument/b9692581-c117-47f3-9524-3deeb69c6d3f" target="_blank">kemençe</a>, they realize one of the most carefully thought performances of <bdi><a title="Neyzen Salih Dede" href="http://musicbrainz.org/artist/4db117ea-b108-4cdd-8e8a-3b4c984a3595">Neyzen Salih Dede</a>'s timeless composition. Apart from <a title="Türkan, Derya" href="http://musicbrainz.org/artist/b80cd1ab-a00c-4f98-89c1-a798deb2d5c2">Derya Türkan</a>'s signature tone and <bdi><a title="Aydemir, Murat" href="http://musicbrainz.org/artist/9b6e98f8-b695-45da-8c9c-68d4bab460fd">Murat Aydemir</a>'s evident plectrum technique, the performance conveys some of the most brilliant heterophonic interactions. Focusing on the 4th Hane, one can easily spot the richness such expressivity. Here you can also observe that the predominant melody extraction is switching between two instruments, hence have many octave errors. Here, we are easily fixing the pitch heights by referring to the aligned note.</bdi></bdi></bdi>
            </p>
            <li><a href="/makam/recording/37dd6a6a-4c19-4a86-886a-882840d59518" ><b>Pençgah Solo</b></a></li>
        <p>
        In this recording <a href="http://musicbrainz.org/artist/4acf1b6d-910a-4540-9a8f-aadcef86eb0c">Niyazi Sayin</a>, one of the grandmasters of ney, performs 4 taksims and 3 compositions simultaneously. During the performance he uses the same ney, which implies the same ahenk (transposition). Until the start of the 3rd taksim, the tonic is performed approximately at 403 Hz. It shifts to 362 Hz within the performance of 3rd Taksim and stays the same in the performance of <a href="http://musicbrainz.org/work/01412a5d-1858-43b3-b5b0-78f383675e9b">Acemaşiran Peşrev</a> (1492 to 1773 seconds).

        In this example we are focusing on the performance of <a href="http://musicbrainz.org/work/01412a5d-1858-43b3-b5b0-78f383675e9b">Acemaşiran Peşrev</a>, the last performance. Here we want to demonstrate that, 1) our system is able to match the tonic of a subperformance, 2) our system is able to align subperformances.
        </p>
        </ul>
    </div>  
    <div class="clearfix"></div>
</div>
{% endblock %}

