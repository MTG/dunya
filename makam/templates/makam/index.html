{% extends "makam/base.html" %}
{% load staticfiles %}
{% load makam.inline %}

{% block extra_css %}
    {% if debug %}
    {% load less %}
    {% load static %}
    <link rel="stylesheet" type="text/css" href="{% get_static_prefix %}{% less 'carnatic/css/pages.less' %}" />
    {% else %}
    <link rel="stylesheet" type="text/css" href="{% static 'carnatic/css/pages.css' %}" />
    {% endif %}
{% endblock %}
{% block title %}Makam index | {% endblock %}
{% block script %}
<style>

  .custom-combobox {
    position: relative;
    display: inline-block;
  }
  .custom-combobox-toggle {
    position: absolute;
    top: 0;
    bottom: 0;
    margin-left: -1px;
    padding: 0;
  }
  .custom-combobox-input {
    margin: 0;
    padding: 5px 10px;
  }
#one-column-emphasis th
{
  font-size: 14px;
  font-weight: normal;
  padding: 12px 15px;
  color: #039;
}
#one-column-emphasis td
{
  padding: 10px 15px;
  color: #669;
  border-top: 1px solid #e8edff;
  width: 300px;
vertical-align: top;
}
.oce-first
{
  background: #d0dafd;
  border-right: 10px solid transparent;
  border-left: 10px solid transparent;
}
#one-column-emphasis tr:hover td
{
  color: #339;
  background: #eff2ff;
}
#one-column-emphasis
{
  font-family: "Lucida Sans Unicode", "Lucida Grande", Sans-Serif;
  font-size: 12px;
  margin-left: 45px;
  width: 480px;
  text-align: left;
  border-collapse: collapse;
}
#one-column-emphasis th
{
  font-size: 14px;
  font-weight: bold;
  padding: 12px 15px;
  color: #039;
}
#one-column-emphasis td a
{
  color: #669;
  text-decoration: none;
  display:block;
  height:100%;
  width:100%;
} 
.filters{
  padding-left: 42px;
 /* color: #339;*/
  margin-top: 5px;
}
.pagination{
margin: 10px 0 25px 42px;
font-size: 14px;
}
.step-links{
border-top: 1px black solid;
}
#right-display{
  position: fixed;
  top: 100px;
  right: 100px;
  border: 1px #ccc solid;
  padding: 13px;
  border-radius: 9px;
  background-color: #FFFFD1;
}
#right-display ul{
list-style-type: none;
}
#right-display a{
  text-decoration: none;
  color: #339;
}
td.recodings{
width: 400px;
}
a:hover{
  text-decoration: underline !important;
}
h2{
  margin: 30px 0 0 20px;
  color: #46433a;
  font-size: 30px;
  font-family: 'Roboto', sans-serif;
  font-weight: 300;
}
#results{
margin-left: 30px;
}
#initial, #loading, #no-results{
  font-family: 'Sintony', sans-serif;
  font-size: 14px;
  margin-left: 30px;
  margin-top: 40px;
  color: #46433a;
  min-height: 20px;
  padding: 19px;
  margin-bottom: 20px;
  background-color: #f9f6f5;
  border: 1px solid #ebe2df;
  border-radius: 2px;
  -webkit-box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.05);
  box-shadow: inset 0 1px 1px rgba(0, 0, 0, 0.05);
  max-width: 1200px;
}
#initial a{
  color: #46433a;
  text-decoration: none;
}
#next-page{
  display: inline-block;
  padding: 5px 14px;
  background-color: #ffffff;
  border: 1px solid #dddddd;
  border-radius: 2px;
margin: 20px;
}
</style>
<script src="{% static 'makam/js/works.js' %}"></script>
<script>
$(function() {      
    $( "#combo-artist" ).combobox();
      $( "#toggle" ).click(function() {
          $( "#combo-artist" ).toggle();
     });
  });
function loadTable(data){
  $('#no-results').hide();
  if (data['results'].length==0){
    $('#next').hide();
    $('#results').hide();
    var usul = $('#usul-filter option:selected').val(); 
    var makam = $('#makam-filter option:selected').val(); 
    var form = $('#form-filter').find('option:selected').val();
    var artist = $('#combo-artist option:selected').val();
    
    if (usul || makam || form || artist){
        $('#no-results').find('h3').html("There are no results for this search. Try removing some filters.");
    }else{
        $('#no-results').find('h3').html("There are no results for this search.");
    }
    $('#no-results').show();
    $('#initial').show();
  }else{
    if(data['next']){
      $('#next').show();
      $('#next a').attr('href', data['next']);
    }else{
      $('#next').hide();
    }
    $('#one-column-emphasis').html('<tr><th scope="col">Work name</th><th scope="col">Composer</th><th scope="col">Recordings</th></tr>');
    for(var i=0; i<data['results'].length; i++){
      var artists="";
      var art=data['results'][i]['composers'];
      for(var j=0;j<art.length;j++){
        artists += " "+art[j]['name'];
      }
      $('#one-column-emphasis').append('<tr class="work"><td height="30">'+ data['results'][i]['title'] +'</td><td >'+ artists +'</td><td><div class="recordings" data-id="'+ data['results'][i]['mbid']+'"><a href="#">Show</a></div></td></tr>');
    }
    $('#initial').hide();
  }
}

function getWorks(txt){
  $('#loading').show();
  var usul = $('#usul-filter option:selected').val(); 
  var makam = $('#makam-filter option:selected').val(); 
  var form = $('#form-filter').find('option:selected').val();
  var artist = $('#combo-artist option:selected').val();
   
  $.ajax({
      method: "GET",
      url: "{% url "api-makam-work-list" %}",
      dataType: "json",
      data: {"q":txt.trim(),"usul":usul, "artist":artist, "form":form, "makam": makam},
      }).done(function(data) {
         $('#results').show();
         loadTable(data); 
         $('#loading').hide();
      }).fail(function(jqXHR, textStatus ){
         $('#loading').hide();
      });
}

$( document ).ready(function() {
 $("#work-query").keyup(function(event) {
  var stt=$(this).val();
  getWorks(stt); 
  });
  $('form.filters').submit(function() {
    return false;
    });
  $("#submit-filters").submit(function(){
    getWorks($('#work-query').val());
    return false;
  });
  
  // WHEN CLICK SHOW THE RECORDINGS FOR A WORK
  $('#one-column-emphasis').on('click','div.recordings', function() {
   var work=$(this);
   $.ajax({
    method: "GET",
    url: "/api/makam/work/" +$(this).attr('data-id'),
    dataType: "json",
    }).done(function(data) {
     $('.recordings').each(function(){$(this).html('<a href="#"">Show</a>')});; 
     work.html('<ul></ul>');
     for(var i=0; i<data['recordings'].length; i++){
       var art=data['recordings'][i]['artists'];
       var artists="";
       for(var j=0;j<art.length;j++){
         artists += " "+art[j]['name'];
       }
       work.parent().find('ul').append('<li><a href="/makam/recording/'+data['recordings'][i]['mbid'] +'">'+data['recordings'][i]['title'] + ' ('+ artists +')</li>'); 
     }
    }); 
      
  });
$(function() {      
    $( "#combo-artist" ).combobox();
      $( "#toggle" ).click(function() {
          $( "#combo-artist" ).toggle();
     });
  });
$('#disp-filters-btn').click(function(){
    $("#disp-filters").toggle();
});
$('#next-page').click(function(){
 var href = $(this).attr('href');
 $.ajax({
      method: "GET",
      url: href,
      dataType: "json",
      }).done(function(data) {
         loadTable(data); 
    });
return false;
});

});
</script>
{% endblock%}
{%block extra-search%}
        <label for="query">Work name</label>
        <input type="text" name="query" id="work-query"/>
        <div><a href="#" id="disp-filters-btn">Show filters</a></div>
 
{% endblock%}

{% block wrap %}
<div id="detail"   style="min-height: 850px;">

    <form method="get" class="filters" id="submit-filters">
       <div id="disp-filters" style="display:none">
           <label for="form">Musical Form</label>
           <select name="form" id="form-filter">
               <option value="">Select</option>
           {% for i in forms%}
               <option value="{{i.pk}}" {%if i.pk|slugify == form %}selected{% endif%}>{{i.name}}</option>
           {% endfor %}
            </select> 
          <label for="usual">Usul</label>
          <select name="usul" id="usul-filter">
             <option value="">Select</option>
             {% for i in usuls%}
                 <option value="{{i.pk}}" {%if i.pk|slugify == usul %}selected{% endif%}>{{i.name}}</option>
             {% endfor %}
          </select>
         <label for="makam">Makam</label>
          <select name="makam" id="makam-filter">
             <option value="">Select</option>
             {% for i in makams%}
                 <option value="{{i.pk}}" {%if i.pk|slugify == usul %}selected{% endif%}>{{i.name}}</option>
             {% endfor %}
          </select>

         <label for="artist">Composer</label>
          <select name="artist" id="combo-artist">
             <option value="">Select one...</option>
             <option value="">Select</option>
             {% for i in artists%}
                 <option value="{{i.pk}}" {%if i.pk|slugify == artist %}selected{% endif%}>{{i.name}}</option>
             {% endfor %}
          </select>
          <input type="submit" value="Search" style="margin-left: 30px;">
        </div>

    </form>
    <div id="results"  style="display:none">
        <h2>Results</h2>    
        <table  style="margin-left:30px;  min-width: 1200px;" id="one-column-emphasis">
        </table>
        <div id="next">
            <a href="#" id="next-page">next</a>
        </div>
    </div>
    <div id="no-results"  style="display:none">
        <h3> There are no results for this search. 
        </h3>
    </div>

    <div id="loading" style="display:none">
        <p> Please wait, loading
        <img src="{% static 'makam/img/loader.gif' %}" />
        </p>
    </div>
    <div id="initial">
        <p> This is a demo of the work for score alignment for makam music of Turkey</br> You can search for a specific Work or filter by musical form, usul or composer. If you want to see an example you can go to some of the following recordings:</p>
        <h2>Some Examples</h2>
        <ul>
            <li><a href="/makam/recording/dfc16e22-0aae-4bd0-a32c-5c000130e96a" >Sevdi Gönlüm Ey Melek Sima Seni</a></li>
            <li><a href="/makam/recording/4948c836-5485-4a69-8bdc-11fe4559e78f" >Muhayyer Sazsemaisi</a></li>
            <li><a href="/makam/recording/727cff89-392f-4d15-926d-63b2697d7f3f" >Gel Güzelim Çamlıca'ya </a></li>
            <li><a href="/makam/recording/e72db0ad-2ed9-467b-88ae-1f91edcd2c59" >Uşşâk Saz Semâîsi</a></li>
            <li><a href="/makam/recording/37dd6a6a-4c19-4a86-886a-882840d59518" >Pençgah Solo</a></li>
        </ul>
    </div>  
    <div class="clearfix"></div>
</div>
{% endblock %}

